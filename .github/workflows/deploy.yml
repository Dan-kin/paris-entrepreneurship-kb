name: æ„å»ºå’Œéƒ¨ç½²

# è§¦å‘æ¡ä»¶
on:
  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [main]

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½®æƒé™
permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œä¾¿äºæ˜¾ç¤ºæ›´æ–°æ—¶é—´

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. å®‰è£… Python ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML

      # 4. éªŒè¯å†…å®¹æ–‡ä»¶
      - name: éªŒè¯ Markdown æ–‡ä»¶
        run: |
          echo "ğŸ“ æ£€æŸ¥ content ç›®å½•..."
          if [ ! -d "content/stories" ]; then
            echo "âš ï¸  è­¦å‘Š: content/stories ç›®å½•ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºç©ºç›®å½•"
            mkdir -p content/stories
          fi
          if [ ! -d "content/resources" ]; then
            echo "âš ï¸  è­¦å‘Š: content/resources ç›®å½•ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºç©ºç›®å½•"
            mkdir -p content/resources
          fi
          if [ ! -d "content/settings" ]; then
            echo "âš ï¸  è­¦å‘Š: content/settings ç›®å½•ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºé»˜è®¤é…ç½®"
            mkdir -p content/settings
          fi

          # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
          STORY_COUNT=$(find content/stories -name "*.md" 2>/dev/null | wc -l)
          RESOURCE_COUNT=$(find content/resources -name "*.md" 2>/dev/null | wc -l)
          echo "âœ“ æ‰¾åˆ° $STORY_COUNT ä¸ªæ•…äº‹å’Œ $RESOURCE_COUNT ä¸ªèµ„æº"

      # 5. è¿è¡Œæ„å»ºè„šæœ¬
      - name: æ„å»ºç½‘ç«™
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»º..."
          python src/build.py
          echo "âœ“ æ„å»ºå®Œæˆ"

      # 6. éªŒè¯æ„å»ºç»“æœ
      - name: éªŒè¯æ„å»ºç»“æœ
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºç»“æœ..."

          # æ£€æŸ¥å¿…éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          REQUIRED_FILES=(
            "dist/index.html"
            "dist/styles.css"
            "dist/script.js"
            "dist/update-detector.js"
            "dist/data/index.json"
            "dist/data/stories.json"
            "dist/data/resources.json"
            "dist/admin/config.yml"
            "dist/admin/index.html"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ“ $file"
            else
              echo "âœ— $file ä¸å­˜åœ¨"
              exit 1
            fi
          done

          # æ˜¾ç¤ºæ„å»ºç»Ÿè®¡
          echo ""
          echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
          echo "  - dist ç›®å½•å¤§å°: $(du -sh dist | cut -f1)"
          echo "  - æ•…äº‹æ•°æ®: $(wc -l < dist/data/stories.json) è¡Œ"
          echo "  - èµ„æºæ•°æ®: $(wc -l < dist/data/resources.json) è¡Œ"

      # 7. ç”Ÿæˆæ„å»ºä¿¡æ¯
      - name: ç”Ÿæˆæ„å»ºä¿¡æ¯
        run: |
          cat > dist/build-info.json << EOF
          {
            "build_time": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit_sha": "${{ github.sha }}",
            "commit_message": $(echo '${{ github.event.head_commit.message }}' | jq -Rs .),
            "branch": "${{ github.ref_name }}",
            "workflow_run": "${{ github.run_number }}",
            "repository": "${{ github.repository }}"
          }
          EOF
          echo "âœ“ ç”Ÿæˆæ„å»ºä¿¡æ¯"
          cat dist/build-info.json

      # 8. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

      # 9. éƒ¨ç½²åˆ° Netlify
      - name: éƒ¨ç½²åˆ° Netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './dist'
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: |
            Deploy from GitHub Actions
            Commit: ${{ github.event.head_commit.message }}
            SHA: ${{ github.sha }}
          enable-pull-request-comment: false
          enable-commit-comment: false
          enable-commit-status: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        timeout-minutes: 5

      # 10. éƒ¨ç½²æˆåŠŸé€šçŸ¥
      - name: éƒ¨ç½²æˆåŠŸ
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
          echo "ç½‘ç«™åœ°å€: https://paris-entrepreneurship.netlify.app"
          echo "ç®¡ç†åå°: https://paris-entrepreneurship.netlify.app/admin"

      # 11. éƒ¨ç½²å¤±è´¥é€šçŸ¥
      - name: éƒ¨ç½²å¤±è´¥
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1

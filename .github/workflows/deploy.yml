name: Build and Deploy

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install markdown pyyaml pillow

      - name: Create required directories
        run: |
          mkdir -p content/stories
          mkdir -p content/entrepreneurs
          mkdir -p content/resources
          mkdir -p content/events
          mkdir -p content/pages
          mkdir -p public/images/uploads
          mkdir -p public/images/thumbnails

      - name: Create sample content (if needed)
        run: |
          # 创建示例首页配置
          if [ ! -f content/pages/home.md ]; then
            cat > content/pages/home.md << 'EOF'
          ---
          site_title: "移个朋友·巴黎创业"
          site_subtitle: "在巴黎，我们一起创业"
          welcome_message: "这里汇聚了在巴黎创业的华人朋友们的真实经历、实战经验和宝贵资源。"
          ---
          EOF
          fi

          # 创建示例关于页面
          if [ ! -f content/pages/about.md ]; then
            cat > content/pages/about.md << 'EOF'
          ---
          title: "关于我们"
          ---

          ## 移个朋友·巴黎创业

          这是一个专门为在巴黎的华人创业者打造的知识分享平台。

          ### 我们的使命

          - 分享真实的创业故事
          - 连接创业者社区
          - 提供实用的创业资源
          - 促进经验交流

          ### 如何参与

          如果你也在巴黎创业，欢迎分享你的故事！
          EOF
          fi

      - name: Run build script
        run: |
          python src/build.py

      - name: Verify build output
        run: |
          echo "=== Build output verification ==="
          ls -la public/
          if [ -f public/index.json ]; then
            echo "✓ index.json generated"
            cat public/index.json
          else
            echo "✗ index.json not found"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: public/
          retention-days: 30

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: public/

      - name: Display deployment info
        run: |
          echo "=== Deployment Information ==="
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Build output:"
          ls -la public/
          echo ""
          echo "Note: Actual deployment is handled by Netlify"
          echo "Netlify will automatically deploy from the 'public' directory"

      # Netlify 会自动从 GitHub 拉取并部署
      # 这里只是记录部署信息，实际部署由 Netlify 处理

  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: public/

      - name: Test build output
        run: |
          echo "=== Testing build output ==="

          # 检查必需文件
          test -f public/index.html || (echo "✗ index.html missing" && exit 1)
          echo "✓ index.html exists"

          test -f public/styles.css || (echo "✗ styles.css missing" && exit 1)
          echo "✓ styles.css exists"

          test -f public/script.js || (echo "✗ script.js missing" && exit 1)
          echo "✓ script.js exists"

          test -f public/update-detector.js || (echo "✗ update-detector.js missing" && exit 1)
          echo "✓ update-detector.js exists"

          test -f public/index.json || (echo "✗ index.json missing" && exit 1)
          echo "✓ index.json exists"

          test -f public/admin/config.yml || (echo "✗ admin config missing" && exit 1)
          echo "✓ admin config exists"

          test -f public/admin/index.html || (echo "✗ admin index missing" && exit 1)
          echo "✓ admin index exists"

          # 检查 JSON 有效性
          python3 -c "import json; json.load(open('public/index.json'))" || (echo "✗ index.json invalid" && exit 1)
          echo "✓ index.json is valid JSON"

          echo ""
          echo "=== All tests passed ==="
